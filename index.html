<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Penunjuk Arah Kiblat (Kalibrasi Modern)</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: radial-gradient(circle at top, #eef, #ccd);
  }
  #arrow {
    width: 100px; height: 100px;
    transition: transform 0.15s linear;
  }
  button {
    margin-top: 1em;
    padding: 0.5em 1em;
    border-radius: 8px;
    border: none;
    background: #4c7; color: white;
    font-size: 1em;
  }
</style>
</head>
<body>
  <h1>Penunjuk Arah Kiblat</h1>
  <p id="status">Menunggu izin lokasi...</p>
  <svg id="arrow" viewBox="0 0 100 100">
    <polygon points="50,10 60,60 50,50 40,60" fill="red" />
  </svg>
  <button id="startBtn">Aktifkan Sensor Arah</button>

<script>
const kaaba = { lat: 21.422487, lon: 39.826206 };
let qiblaDeg = null;
let compassHeading = 0;

function calcQibla(lat, lon) {
  const φ1 = lat * Math.PI/180, φ2 = kaaba.lat * Math.PI/180;
  const Δλ = (kaaba.lon - lon) * Math.PI/180;
  const θ = Math.atan2(Math.sin(Δλ),
    Math.cos(φ1)*Math.tan(φ2) - Math.sin(φ1)*Math.cos(Δλ));
  return (θ*180/Math.PI + 360) % 360;
}

function updateArrow() {
  if (qiblaDeg === null) return;
  const relative = (qiblaDeg - compassHeading + 360) % 360;
  document.getElementById("arrow").style.transform = `rotate(${relative}deg)`;
}

function updateStatus(msg) {
  document.getElementById("status").innerText = msg;
}

navigator.geolocation.getCurrentPosition(pos => {
  const { latitude, longitude } = pos.coords;
  qiblaDeg = calcQibla(latitude, longitude);
  updateStatus(`Arah kiblat dari lokasi Anda: ${qiblaDeg.toFixed(2)}° dari utara sejati`);
}, () => updateStatus("Gagal membaca lokasi."));

async function startOrientation() {
  try {
    if ('AbsoluteOrientationSensor' in window) {
      const sensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
      sensor.addEventListener("reading", () => {
        const q = sensor.quaternion;
        if (!q) return;

        // Kuaternion → Matriks rotasi (right-handed coordinate)
        const [x, y, z, w] = q;
        const rot = [
          [1 - 2*(y*y + z*z),     2*(x*y - z*w),     2*(x*z + y*w)],
          [2*(x*y + z*w), 1 - 2*(x*x + z*z), 2*(y*z - x*w)],
          [2*(x*z - y*w), 2*(y*z + x*w), 1 - 2*(x*x + y*y)]
        ];

        // Ambil azimuth (heading)
        let heading = Math.atan2(rot[1][0], rot[0][0]) * 180 / Math.PI;
        if (heading < 0) heading += 360;

        // Koreksi orientasi portrait
        compassHeading = heading;
        updateArrow();
      });
      sensor.start();
      updateStatus("Sensor modern aktif ✅ Putar perangkat Anda ke arah utara sejati.");
      return;
    }

    if (typeof DeviceOrientationEvent === "undefined") {
      updateStatus("Sensor orientasi tidak tersedia.");
      return;
    }
    if (typeof DeviceOrientationEvent.requestPermission === "function") {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res !== "granted") throw new Error("Izin sensor ditolak");
    }

    window.addEventListener("deviceorientation", e => {
      if (e.alpha !== null) {
        compassHeading = 360 - e.alpha;
        updateArrow();
      }
    });
    updateStatus("Sensor arah aktif (versi lama) ✅");
  } catch (err) {
    updateStatus("Gagal aktifkan sensor: " + err.message);
  }
}

document.getElementById("startBtn").addEventListener("click", startOrientation);
</script>
</body>
</html>
