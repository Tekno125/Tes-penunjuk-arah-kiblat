<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Penunjuk Arah Kiblat (Modern)</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: radial-gradient(circle at top, #eef, #ccd);
  }
  #arrow {
    width: 100px; height: 100px;
    transition: transform 0.2s linear;
  }
  button {
    margin-top: 1em;
    padding: 0.5em 1em;
    font-size: 1em;
    border: none;
    border-radius: 8px;
    background: #4c7; color: white;
  }
</style>
</head>
<body>
  <h1>Penunjuk Arah Kiblat</h1>
  <p id="status">Menunggu izin lokasi...</p>
  <svg id="arrow" viewBox="0 0 100 100">
    <polygon points="50,10 60,60 50,50 40,60" fill="red" />
  </svg>
  <button id="startBtn">Aktifkan Sensor Arah</button>

<script>
const kaaba = { lat: 21.422487, lon: 39.826206 };
let qiblaDeg = null;
let compassHeading = 0;

function calcQibla(lat, lon) {
  const φ1 = lat * Math.PI/180, φ2 = kaaba.lat * Math.PI/180;
  const Δλ = (kaaba.lon - lon) * Math.PI/180;
  const θ = Math.atan2(Math.sin(Δλ),
    Math.cos(φ1)*Math.tan(φ2) - Math.sin(φ1)*Math.cos(Δλ));
  return (θ*180/Math.PI + 360) % 360;
}

function updateArrow() {
  if (qiblaDeg === null) return;
  const relative = (qiblaDeg - compassHeading + 360) % 360;
  document.getElementById("arrow").style.transform = `rotate(${relative}deg)`;
}

function updateStatus(msg) {
  document.getElementById("status").innerText = msg;
}

// Dapatkan lokasi
navigator.geolocation.getCurrentPosition(pos => {
  const { latitude, longitude } = pos.coords;
  qiblaDeg = calcQibla(latitude, longitude);
  updateStatus(`Arah kiblat dari lokasi Anda: ${qiblaDeg.toFixed(2)}° dari utara sejati`);
}, () => updateStatus("Gagal membaca lokasi. Izinkan akses lokasi di browser."));

async function startOrientation() {
  try {
    // Jika tersedia, gunakan API sensor modern
    if ('AbsoluteOrientationSensor' in window) {
      const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
      sensor.addEventListener("reading", () => {
        const q = sensor.quaternion;
        if (q) {
          // konversi quaternion ke heading
          const yaw = Math.atan2(2*(q[0]*q[3] + q[1]*q[2]), 1 - 2*(q[2]**2 + q[3]**2));
          compassHeading = (yaw * 180/Math.PI + 360) % 360;
          updateArrow();
        }
      });
      sensor.start();
      updateStatus("Sensor modern aktif ✅");
      return;
    }

    // Jika tidak, pakai cara lama dengan izin manual
    if (typeof DeviceOrientationEvent === "undefined") {
      updateStatus("Sensor orientasi tidak tersedia.");
      return;
    }
    if (typeof DeviceOrientationEvent.requestPermission === "function") {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res !== "granted") throw new Error("Izin sensor ditolak");
    }

    window.addEventListener("deviceorientation", e => {
      if (e.alpha !== null) {
        compassHeading = 360 - e.alpha;
        updateArrow();
      }
    });
    updateStatus("Sensor arah aktif (versi lama) ✅");
  } catch (err) {
    updateStatus("Gagal aktifkan sensor: " + err.message);
  }
}

document.getElementById("startBtn").addEventListener("click", startOrientation);
</script>
</body>
</html>
